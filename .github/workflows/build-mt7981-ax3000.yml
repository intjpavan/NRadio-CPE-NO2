name: Build MT7981 AX3000
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Fix or remove broken submodule entries
        run: |
          # Remove submodule entries that lack a URL to avoid fatal submodule errors
          if [ -f .gitmodules ]; then
            git config -f .gitmodules --get-regexp '^submodule\..*\.path$' | while read key path; do
              name=$(echo "$key" | sed -E 's/^submodule\.(.*)\.path$/\1/')
              url=$(git config -f .gitmodules --get "submodule.$name.url" || true)
              if [ -z "$url" ]; then
                p=$(git config -f .gitmodules --get "submodule.$name.path" || true)
                if [ -n "$p" ] && [ -d "$p" ]; then
                  git rm -f --cached "$p" || true
                  rm -rf "$p" || true
                fi
                git config -f .gitmodules --remove-section "submodule.$name" || true
              fi
            done
          fi

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gcc \
            gawk \
            gettext \
            git \
            libncurses5-dev \
            libssl-dev \
            python3 \
            python3-pip \
            rsync \
            subversion \
            swig \
            unzip \
            wget \
            zlib1g-dev \
            xsltproc \
            file

      - name: Prepare .config
        run: |
          cp defconfig/mt7981-ax3000.config .config
          make defconfig

      - name: Download feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build firmware
        run: |
          make -j$(nproc) V=s

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-mt7981-ax3000
          path: |
            bin/targets/**/*
