name: Build MT7981 AX3000

on:
  # Manual trigger
  workflow_dispatch:
  # Optional: build on pushes to main (you can change/remove this)
  push:
    branches:
      - main

env:
  TZ: Asia/Kolkata

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang clangd cmake cpio curl device-tree-compiler ecj fastjar flex \
            gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool \
            lib32gcc-s1 libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libncursesw5 libncursesw5-dev \
            libreadline-dev libssl-dev libtool lld lldb lrzsz mkisofs msmtp nano \
            ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pip \
            python3-ply python-docutils qemu-utils re2c rsync scons squashfs-tools \
            subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev

      # Optional but recommended: cache the downloads to speed up subsequent builds
      - name: Cache dl directory
        uses: actions/cache@v4
        with:
          path: dl
          key: dl-${{ runner.os }}-${{ hashFiles('feeds.conf*', 'defconfig/mt7981-ax3000.config') }}
          restore-keys: |
            dl-${{ runner.os }}-

      - name: Update & install feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Use mt7981-ax3000.config
        run: |
          cp -f defconfig/mt7981-ax3000.config .config
          # Expand config, in case there are new symbols
          make defconfig

      - name: Build firmware
        run: |
          make -j"$(nproc)" || make -j1 V=s

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mt7981-ax3000-firmware
          path: |
            bin/targets/**
          if-no-files-found: error
